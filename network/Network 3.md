# Network 3.

---

혼공 Network

---

## 3-1  네트워크 계층

LAN이 아닌 다른 네트워크들과 통신하려면 네트워크 계층의 역할이 필수적임

물리 계층과 데이터 링크 계층만으론 지구 반대편 까지 패킷을 보내기엔 무리다.

1. **다른 네트워크까지의 도달 경로를 파악하기 어려움**
    
    다른 네트워크 까지 가려면 다양한 네트워크 장비와 경로를 거쳐야함
    
    최적의 경로를 결정하는 것을 `라우팅` 이라고 함
    
    이를 해주는 것이 네트워크 계층의 `라우터` 임
    
2. **MAC 주소만으론 모든 네트워크에 속한 호스트를 특정하기 어려움**
    
    예를들어 옷가게에서 데님 숏팬츠를 산다고 치자
    
    그러면 바지 코너에 가서 청바지 행거를 찾는다. 분류가 잘되어있으니까 찾기 쉽다.
    
    근데 동묘 시장에 널부러진 옷더미에 찾기는 어려울 것이다.
    
    브루트포스마냥 처음부터 끝까지 탐색해야할것이다…
    
    그래서 바지 코너의 청바지 행거처럼 `IP 주소` 를 사용한다.
    
    MAC 주소가 데님 숏팬츠라고 생각하면 편하다
    
    MAC 주소가 물리 주소고, IP 주소가 논리 주소다.
    
    IP는 DHCP 프로토콜로 호스트에 자동으로 할당하거나 직접 할 수 있음
    

### 인터넷 프로토콜

인터넷 프로토콜 = IP

IPv4, IPv6 두버전이 있는데 흔히 IP 주소라고 하면 v4인 경우가 대다수

`192.168.1.1`

4바이트, 자리당 8비트로 표현 → 0~255 범위의 4개의 10진수로 표기

IP 주소 지정 : IP 주소를 바탕으로 송수신 대상을 지정

IP 단편화 : 전송하고자 하는 패킷의 크기가 MTU(최대 전송 단위)보다 클 경구 복수의 패킷으로 나누는 것

MTU : 한번에 전송 가능한 IP 패킷의 최대 크기. 일반적으로 1500바이트

- IPv4
    
    IPv4 패킷은 프레임에 페이로드로 데이터 필드에 명시됨
    
    ![출처 : 정보통신기술용어해설](Network%203%20eccff4b808e74eb69fd2a318f24d470a/image.png)
    
    출처 : 정보통신기술용어해설
    
    **구성요소 (핵심 필드)**
    
    식별자(Identifier) : 패킷에 할당된 번호 : 패킷들이 어떤 메세지에서 쪼개졌는지 인식
    
    플래그(Flags) : 3개의 비트로 구성 : [0(미사용), DF, MF] 로 구성
    
    DF : Don’t Fragment : IP 단편화 수행 가능 여부 0 : False, 1 : True
    
    MF : More Fragment : 단편화 된 패킷의 남은지 여부 0: 있음, 1 : 없음
    
    단편화 오프셋(fragment offset) : 단편화 이전 초기 데이터로부터 떨어진 거리
    
    TTL(Time to Live) : 패킷의 수명 : 라우터를 거칠때 마다 1 감소 0이면 폐기
    
    프로토콜(Protocol ID) : 상위 계층의 프로토콜을 나타냄
    

- IPv6
    
    IPv4의 이론적 최대 갯수 : 약 43억개로 전 세계 인구에 부족한 갯수
    
    그냥 갯수 늘릴려고 만든거 같음
    
    16바이트 주소 표현 : 이론 상 $2^{128}$개 가능
    
    그리고 IPv6는 v4에 비해 패킷 기본 헤더가 간소화 되어 있다.
    
    ![출처 : 정보통신기술용어해설](Network%203%20eccff4b808e74eb69fd2a318f24d470a/image%201.png)
    
    출처 : 정보통신기술용어해설
    
    **구성 요소 (핵심 필드)**
    
    다음 헤더(Next Header) : 상위 프로토콜 or 확장 헤더를 가르킴
    
    확장 헤더 : 여러 옵션이 있음 홉 간 옵션, 수신지 옵션 등…
    
    홉 제한(Hop Limit) : 패킷의 수명을 나타내는 필드
    

### ARP

IP 주소를 통해 MAC 주소를 알아내는 프로토콜

기본적으로 IP 주소를 통해 통신하는데, 패킷을 올바르게 보내려면 상대 호스트의 MAC 주소까지 알아야함

> **ARP 패킷**
> 
> 
> ![출처 : 정보통신용어기술해설](Network%203%20eccff4b808e74eb69fd2a318f24d470a/image%202.png)
> 
> 출처 : 정보통신용어기술해설
> 
> 페이로드에 포함되어 전송됨
> 
> 오퍼레이션 코드 : ARP 패킷 유형 : 요청 - 1, 응답 - 2
> 
> 나머진 IP, MAC 주소임
> 

**동일 네트워크의 A와 B ARP 통신 과정**

1. ARP 요청
    
    네트워크 내 브로드캐스트 메세지로 ARP 요청을 보냄 (ARP 패킷임)
    
    → 본인 제외 네트워크 소속된 모든 호스트에게 B 아이피 주소 들고 누군지 물어보는 상황
    
2. ARP 응답
    
    메세지를 B 제외한 호스트는 상관없어서 무시
    
    B가 메세지 받고 A에게 ARP 응답을 함 (MAC주소 포함)
    
3. ARP 테이블 갱신
    
    IP - MAC 주소 대응하는 테이블
    
    일정 시간 경과 삭제, 임의로 삭제 가능
    

**다른 네트워크 A와 B ARP 통신 과정**

1. A가 속한 라우터의 MAC주소를 받아온다 (ARP요청 - 응답 과정으로)
2. A의 라우터가 B의 라우터로 A로 부터 받아온 패킷을 전달함 (B의 라우터의 MAC 주소를 모르면 ARP요청 - 응답 과정을 또 함)
3. B가 속한 라우터가 ARP 요청 - 응답 과정을 거쳐 B의 MAC 주소를 찾아서 보냄

간략화 된 예시로 ARP만 쓰진 않는다고 함. 짚고 넘어가야 할 점

- ARP는 동일 네트워크에 속한 호스트의 MAC 주소를 알아내기 위해 쓰는 프로토콜
- 다른 네트워크의 호스트에게 패킷을 보내려면 네트워크 외부로 나가기 위한 장비(라우터)의 MAC 주소를 알아야함

> **IP 단편화 줄이기**
> 
> 
> IP 단편화는 패킷을 쪼개서 보내기에 불필요한 트래픽과 대역폭을 낭비하게 됨
> 
> 가급적 피하는게 좋음
> 
>  **HOW TO?**
> IP 패킷을 주고 받는 모든 호스트의 처리 가능한 MTU를 고려하기
> 
> 가령 호스트 A가 1기가 처리할 수 있다고 해도 라우터가 지원하지 못한다면 어쩔 수 없이 단편화 해야함
> 
> IP 단편화 없이 주고 받을 수 있는 최대 크기 = `경로 MTU` 
> 
> 딱 경로 MTU만큼만 주고 받는게 최고 좋은 상황
> 
> 경로 MTU를 구하고 이를 통해 단편화를 피하는 기술을 `경로 MTU 발견`이라함
> 

---

## 3-2 IP 주소

IP 주소는 기본적으로 네트워크 통신에서 많이 사용되기에 더 살펴보겠다.

네트워크 주소와 호스트 주소로 이루어져 있음

[xxx.xxx.xxx.xxx](http://xxx.xxx.xxx.xxx) 10진수 기준 원래는 8비트

옥텟으로 네트워크, 호스트 주소를 유동적으로 나눌 수 있다.

네트워크 : 호스트 주소 = 1 : 3, 1 : 1, 3 : 1 처럼 나눌 수 있음

### 클래스풀 주소 체계

`클래스` : 네트워크 크기에 따라 IP 주소를 분류하는 기준

`클래스 풀 주소 체계`: 클래스 기반으로 IP 주소를 관리하는 주소 체계

클래스 A~E까지 있는데 D와 E는 특수한 목적을 위한 클래스라 네트워크 크기를 나누는 데 실질적인 클래스는 A, B, C임

Class A = 1 : 3

Class B = 1 : 1

Class C = 3 : 1

A 클래스의 네트워크 주소의 시작 비트가 0으로 시작함

그래서 0.0.0.0 ~ 127.255.255.255가 범위임 (십진수)

B 클래스는 네트워크 주소의 비트가 10으로 시작

128.0.0.0 ~ 191.255.255.255 (십진수)

C클래스는 110으로 시작함

192.0.0.0 ~ 223.255.255.255 (십진수)

### 클래스리스 주소 체계

클래스마다 호스트 수 차이가 너무 많이 난다. A와 B만 계산해도  1600만개 ~ 6만개 이렇다.

그래서 좀 더 유동적이고 정교하게 구성하는 대안으로 나온 방식이 `클래스리스 주소 체계` 

현재도 많이 쓰는 방식

- **서브넷 마스크**
    
    클래스를 쓰면 옥텟 단위로 잘라 쓰니까 호스트와 네트워크가 어디까지인지 알수 있음
    
    근데 클래스리스는 그게 안되니까 서브넷 마스크를 사용함
    
    IP 주소 상 네트워크 주소는 1 호스트 주소는 0으로 표기한 비트열을 의미
    
    서브넷 마스크로 클래스를 더 잘게 쪼개는 것을 서브네팅이라고 함
    
    **비트 AND 연산**
    
    서브넷 마스크로 호스트와 네트워크를 구분 짓는 방법은 간단함
    
    IP주소와 서브넷 마스크를 비트 AND 연산 하면 됨
    
    IP 주소 : 192.168.219.103
    
    서브넷 : 255.255.255.0
    
    > IP                   11000000.10101000.11011011.01100111
    서브넷            1111111111.1111111111.111111111.0000000
    ————————-———————————————————-
    네트워크 주소 11000000.10101000.11011011.000000
    > 
    
    = 192.168.219.0
    
    이러면 호스트가 0이 되니까 어디까지 네트워크 주소인지 알 수 있음
    
    **CIDR 표기법**
    
    서브넷 마스크의 표기 방법 중 하나
    
    위에 10진수처럼 나타내는 방법도 있긴 함
    
    되게 간단한데 서브넷 마스크를 2진수로 나타내고, 1의 갯수를 IP뒤에 `/`랑 붙이면 됨
    
    192.168.219.103/24 << 이렇게
    

### 공인 IP

IP는 고유한거랑 중복되는게 있는데 공인 IP는 고유함

네트워크 간 통신, 인터넷을 이용할 때 사용하는 IP 주소가 공인 IP 주소임

할당받으려면 공인 IP 주소 할당 기관이나 ISP를 통해 받을 수 있음

### 사설 IP

사설 네트워크에서 사용하기 위한 IP 주소

사설 네트워크 : 인터넷, 외부 네트워크에 공개되지 않은 네트워크

주변 인터넷 되는 전자 기기만 봐도 IP 주소를 전부 신청해서 받은게 아니잖아?

LAN 내 많은 호스트는 사설 IP 주소를 씀

사설 IP 할당의 주체는 라우터임 할당 받은 IP 주소는 해당 호스트가 속한 사설 네트워크 상에서만 유효한 주소임

다른 네트워크 IP랑 중복될 수 있음

`NAT` : IP 주소 변환 기술

네트워크 내부 사설 IP 주소 → 네트워크 외부 공인 IP 주소로 변환

라우터에 NAT 기능이 탑재되어있음

### 정적 IP 주소

`정적 할당` : 호스트에게 수동으로 IP 주소를 부여하는 방식

정적 할당을 통한 IP를 `정적 IP 주소` 라고 함

### 동적 IP 주소

`동적 할당` : 호스트의 IP를 자동으로 할당하는 방식

마찬가지로 `동적 IP 주소` 라고 함

노트북이나 핸드폰으로 WIFI 연결했을 때, 따로 IP 설정 안하고 쓰잖아요 바로 그거임

`DHCP` : 호스트의 IP와 TCP/IP 프로토콜 기본 설정을 클라이언트에게 자동으로 할당하는 프로토콜

DHCP 서버(일반적으로 라우터)가 호스트에게 메세지를 주고 받으며 IP 주소를 제공함

임대 기간이 있어 만료되면 IP 주소를 다시 반납한다.

1. DHCP Discover (Client → DHCP Server)
    
    브로드캐스트 메세지로 DHCP 서버를 발견함(Discover)
    
    아직 IP를 할당받지 못했으니 송신지 IP는 0.0.0.0으로 표기함
    
2. DHCP Offer (DHCP Server → Client)
    
    IP 주소, 서브넷, 임대기간 등 해서 다시 클라이언트에게 송신함
    
3. DHCP Request(Client → DHCP Server)
    
    브로드 캐스트로 다시 받았다는 신호로 응답
    
4. DHCP ACK(DHCP Server → Client)
    
    최종 승인으로 임대기간동안 허가 해주는 느낌의 메세지를 클라이언트에게 보냄
    

임대 기간이 끝나면 원칙적으로 똑같이 과정을 거쳐야하지만, 임대 기간을 연장할 수 있음

`임대 갱신` 이라고 함 기본적으로 2번 자동 수행됨

---

## 3-3 라우팅

`라우팅` : 네트워크 내 패킷을 보낼 최적의 경로를 선택하는 과정

### 라우터

한 개 이상의 LAN 간에 데이터를 전달하는 게이트웨이

라우터를 통해 다른 네트워크의 호스트까지 데이터를 통신함

이렇게 라우터 간 이동하는 하나의 과정을 `홉` 이라고 함

### 라우팅 테이블

특정 수신지까지 도달하기 위한 정보를 명시한 표

- 구성
    
    `수신지 IP` , `서브넷 마스크`  : 수신 받을 대상을 위함
    
    `다음 홉` : 수신지까지의 다음 거쳐야 할 호스트의 IP나 인터페이스 `게이트웨이` 라고도 함
    
    `네트워크 인터페이스` : 패킷을 보낼 통로 NIC 혹은 대응하는 IP가 명시됨
    
    `메트릭` : 해당 경로 이동 비용 (메트릭이 낮은 경로를 선호)
    

특정 수신지로 패킷을 보낼 때 수신지가 테이블에 없는 경우

`디폴트 라우트` 경로로 보냄 → 0.0.0.0/0으로 모든 IP 주소를 의미함

### 정적 라우팅

사용자가 수동을 직접 채워넣은 라우팅 테이블을 바탕으로 라우팅하는 방식

### 동적 라우팅

자동으로 라우팅 테이블을 만들고 이를 라우팅 하는 방식

### 라우팅 프로토콜

정적 라우팅은 경유하는 라우터의 문제가 발생해도 이를 자동으로 교체 못함

동적라우팅은 가능한데, 라우터끼리 서로 라우팅 프로토콜로 통신을 함

`라우팅 프로토콜` : 라우터 간 정보를 교환하여 패킷의 최적 경로를 찾기 위한 프로토콜

- **IGP** Interior Gateway Protocol : AS 내부에서 수행
    
    `RIP` Routing Information Protocol
    
    거리 벡터 기반 라우팅 프로토콜 : 홉 수가 적을수록 메트릭 값도 감소
    
    주기적으로 통신으로 라우팅 테이블을 갱신
    
    `OSPF` Open Shortest Path First
    
    링크 상태 라우팅 프로토콜 : 대역폭이 높을수록 메트릭 값도 감소
    
    네트워크 상태를 그래프 형태로 `링크 상태 데이터베이스`에 저장함
    
    네트워크 구성이 변경될 때 라우팅 테이블 갱신
    
    규모가 커지면 링크 상태 데이터베이스 관리가 어렵기에 AS를 `Area` 로 나눔
    
    `ABR` Area Border Router가 Area 간 연결을 담당함
    
    > **AS (**Autonomous System)
    > 
    > 
    > 동일한 라우팅 정책으로 운용되는 라우터들의 집단 네트워크
    > 

- **EGP** Exterior Gateway Protocol : AS 외부에서 수행
    
    `BGP` Border Gateway Protocol
    
    AS 간 통신이 가능한 프로토콜
    
    AS - AS 통신 : **eBGP** external BGP
    
    AS 내 통신 : **iBGP** internal BGP
    
    `피어` : BGP 간 연결된 BGP 라우터
    
    피어 관계가 되도록 연결하는 과정을 `피어링` 이라고 함